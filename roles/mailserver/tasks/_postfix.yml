# tasks/postfix.yml -- Install and configure Postfix
---
- name: Postfix - create group for mail ownership
  group:
    name: "{{ postfix_virtual_mailbox_gname }}"
    gid: "{{ postfix_virtual_mailbox_gid }}"

- name: Postfix - create user for mail ownership
  user:
    name: "{{ postfix_virtual_mailbox_uname }}"
    uid: "{{ postfix_virtual_mailbox_uid }}"
    home: "{{ postfix_virtual_mailbox_home }}"
    create_home: yes
    shell: "{{ postfix_virtual_mailbox_shell }}"
    group: "{{ postfix_virtual_mailbox_gname }}"

- name: Postfix - install system packages
  package:
    name: "{{ mailserver_postfix_packages }}"
    state: present

- name: Postfix - add postfix user to 'opendmarc' group
  user:
    name: postfix
    groups:
      - opendmarc
    append: yes
  when: opendmarc_keys is defined

- name: Postfix - add postfix user to 'opendkim' group
  user:
    name: postfix
    groups:
      - opendkim
    append: yes
  when: opendkim_keys is defined

- name: Postfix - render main configuration
  template:
    src: postfix_main.cf.j2
    dest: "{{ postfix_config_dir }}/main.cf"
  notify: Restart postfix service

- name: Postfix - render master configuration
  template:
    src: postfix_master.cf.j2
    dest: "{{ postfix_config_dir }}/master.cf"
  notify: Restart postfix service

- name: Postfix - render virtual alias domains
  copy:
    dest: "{{ postfix_virtual_alias_domains_file }}"
    content: |-
      {% for domain in postfix_virtual_aliases_domains %}
      {{ domain }}
      {% endfor %}
  register: _render_virtual_alias_domains

- name: Postfix - update virtual alias domains db
  shell: >-
    postmap {{ postfix_virtual_alias_domains }}
  when: _render_virtual_alias_domains is changed
  notify: Restart postfix service

- name: Postfix - render virtual aliases
  copy:
    dest: "{{ postfix_virtual_alias_maps_file }}"
    content: |-
      {% for alias in postfix_virtual_aliases %}
      {{ alias.alias }} {{ alias.email }}
      {% endfor %}
  register: _render_virtual_alias

- name: Postfix - update virtual aliases db
  shell: >-
    postmap {{ postfix_virtual_alias_maps }}
  when: _render_virtual_alias is changed
  notify: Restart postfix service

- name: Postfix - render virtual mailboxes
  copy:
    dest: "{{ postfix_virtual_mailbox_maps_file }}"
    content: |-
      {% for alias in postfix_virtual_mailboxes %}
      {{ alias.email }} {{ alias.recipient }}
      {% endfor %}
  register: _render_virtual_mailboxes

- name: Postfix - update virtual mailboxes db
  shell: >-
    postmap {{ postfix_virtual_mailbox_maps }}
  when: _render_virtual_mailboxes is changed
  notify: Restart postfix service

- name: Postfix - render transports
  copy:
    dest: "{{ postfix_transport_maps_file }}"
    content: |-
      {% for transport in postfix_transports %}
      {{ transport.domain }} {{ transport.transport }}
      {% endfor %}
  register: _render_transports

- name: Postfix - update transports db
  shell: >-
    postmap {{ postfix_transport_maps }}
  when: _render_transports is changed
  notify: Restart postfix service
