---
- name: Add project apt signing key
  apt_key:
    url: https://packages.matrix.org/debian/matrix-org-archive-keyring.gpg
    state: present

- name: Add project apt repository
  apt_repository:
    repo: "deb https://packages.matrix.org/debian/ {{ ansible_lsb.codename }} main"
    state: present
    filename: matrix
    update_cache: yes

- name: Install system packages
  apt:
    name:
      - matrix-synapse-py3

- name: Set matrix server name Debian-style
  lineinfile:
    dest: /etc/matrix-synapse/conf.d/server_name.yaml
    regex: >-
      ^server_name:.*
    line: >-
      server_name: {{ matrix_server_name }}

- name: Render matrix configuration file
  template:
    src: homeserver.yaml.j2
    dest: /etc/matrix-synapse/homeserver.yaml
  notify: Restart matrix service

- name: Render nginx configuration file
  template:
    src: matrix.nginx.conf.j2
    dest: /etc/nginx/sites-enabled/matrix.conf
  notify: Restart nginx service

- name: Add yarn apt signing key
  apt_key:
    url: https://dl.yarnpkg.com/debian/pubkey.gpg
    state: present

- name: Add yarn apt repository
  apt_repository:
    repo: "deb https://dl.yarnpkg.com/debian/ stable main"
    state: present
    filename: matrix
    update_cache: yes

- name: Install Yarn
  apt:
    name:
      - yarn
      - nodejs
      - npm

- name: Clone riot web sources
  git:
    repo: "https://github.com/vector-im/riot-web.git"
    dest: /usr/src/riot-web
    version: "v1.5.12"

- name: Install riot-web dependencies
  shell: >-
    yarn install
  args:
    chdir: /usr/src/riot-web
    creates: /usr/src/riot-web/dist/riot-v1.5.12.tar.gz


- name: Install riot-web dependencies
  shell: >-
    yarn dist
  args:
    chdir: /usr/src/riot-web
    creates: /usr/src/riot-web/dist/riot-v1.5.12.tar.gz

- name: Expand riot-web dist
  unarchive:
    src: /usr/src/riot-web/dist/riot-v1.5.12.tar.gz
    remote_src: yes
    dest: /var/www/
    creates: /var/www/riot-v1.5.12

- name: Configure riot-web
  template:
    src: "riot-web.config.json.j2"
    dest: "/var/www/riot-v1.5.12/config.json"
  notify: Restart nginx service

- name: Render nginx configuration file
  template:
    src: riot.nginx.conf.j2
    dest: /etc/nginx/sites-enabled/riot.conf
  notify: Restart nginx service
